// =============================================================
// UNIVERSAL SCRIPT for dashboard.html and quote.html
// Works for both pages (dashboard + quote)
// Includes search, quote creation, saving, tab navigation
// =============================================================

const QUOTES_KEY = "quotes";
const DRAFT_KEY = "quoteDraft";

/* ---------- TOAST UTILITY ---------- */
function showToast(message, type = "success") {
  let container = document.querySelector(".toast-container");
  if (!container) {
    container = document.createElement("div");
    container.className = "toast-container position-fixed top-0 end-0 p-3";
    document.body.appendChild(container);
  }
  const toast = document.createElement("div");
  toast.className = `toast align-items-center text-bg-${type} border-0 show shadow mb-2`;
  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body fw-semibold">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

/* ---------- LOCAL STORAGE HELPERS ---------- */
function saveQuotes(quotes) {
  localStorage.setItem(QUOTES_KEY, JSON.stringify(quotes));
}
function getQuotes() {
  return JSON.parse(localStorage.getItem(QUOTES_KEY)) || [];
}
function saveQuoteToStorage(quote) {
  const quotes = getQuotes();
  quotes.unshift(quote);
  saveQuotes(quotes);
}

/* =============================================================
   PAGE DETECTION
   ============================================================= */
document.addEventListener("DOMContentLoaded", () => {
  const path = window.location.pathname;
  if (path.includes("dashboard.html")) initDashboard();
  if (path.includes("quote.html")) initQuotePage();
});

/* =============================================================
   DASHBOARD PAGE LOGIC
   ============================================================= */
function initDashboard() {
  const tableBody = document.querySelector("#recentQuotesTable tbody");
  const searchInput = document.querySelector("input[placeholder='Search customer...']");
  const startQuoteButtons = document.querySelectorAll("#startQuoteBtn, #startQuoteCardBtn, .startQuoteBtn");

  function renderTable(filter = "") {
    const quotes = getQuotes();
    const filtered = quotes.filter((q) => {
      const fullName = `${q.firstName} ${q.lastName}`.toLowerCase();
      const policy = q.policyForm?.toLowerCase() || "";
      return fullName.includes(filter) || policy.includes(filter);
    });

    tableBody.innerHTML = filtered.length
      ? ""
      : `<tr><td colspan="5" class="text-center text-muted py-3">No quotes found.</td></tr>`;

    filtered.forEach((q) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${q.firstName} ${q.lastName}</td>
        <td>${q.policyForm || "—"}</td>
        <td>${q.quoteDescription || "—"}</td>
        <td>${q.ratingState || "—"}</td>
        <td>${q.date || new Date().toLocaleDateString()}</td>`;
      tableBody.appendChild(row);
    });
  }

  renderTable();

  // Live search
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      renderTable(e.target.value.toLowerCase());
    });
  }

  // Start Quote buttons
  startQuoteButtons.forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      window.location.href = "quote.html";
    });
  });
}

/* =============================================================
   QUOTE PAGE LOGIC (Multi-Tab + Save)
   ============================================================= */
function initQuotePage() {
  const form = document.getElementById("quoteForm");
  if (!form) return;

  // Tab controls
  document.querySelectorAll(".next-tab").forEach((btn) => {
    btn.addEventListener("click", function () {
      const nextPane = this.closest(".tab-pane").nextElementSibling;
      if (!nextPane) return;
      const tabId = nextPane.getAttribute("id");
      const nextTab = document.querySelector(`[data-bs-target="#${tabId}"]`);
      new bootstrap.Tab(nextTab).show();
    });
  });

  document.querySelectorAll(".prev-tab").forEach((btn) => {
    btn.addEventListener("click", function () {
      const prevPane = this.closest(".tab-pane").previousElementSibling;
      if (!prevPane) return;
      const tabId = prevPane.getAttribute("id");
      const prevTab = document.querySelector(`[data-bs-target="#${tabId}"]`);
      new bootstrap.Tab(prevTab).show();
    });
  });

  // Save Quote
  form.addEventListener("submit", (e) => {
    e.preventDefault();

    const quote = {
      firstName: form.firstName?.value.trim(),
      lastName: form.lastName?.value.trim(),
      policyForm: form.policyForm?.value,
      quoteDescription: form.quoteDescription?.value,
      ratingState: form.ratingState?.value,
      date: new Date().toLocaleDateString(),
    };

    if (!quote.firstName || !quote.lastName || !quote.policyForm || !quote.ratingState) {
      showToast("Please complete all required fields.", "danger");
      return;
    }

    saveQuoteToStorage(quote);
    showToast("Quote saved successfully!", "success");

    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 1200);
  });
}
